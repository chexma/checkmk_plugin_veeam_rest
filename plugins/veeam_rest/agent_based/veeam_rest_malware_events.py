#!/usr/bin/env python3
"""
Check plugin for Veeam Malware Detection Events.

This check monitors malware events from Veeam's malware detection system,
showing which machines have been flagged and whether events have been
confirmed as false positives.
"""

import json
from collections.abc import Mapping
from datetime import datetime, timezone
from typing import Any

from cmk.agent_based.v2 import (
    AgentSection,
    CheckPlugin,
    CheckResult,
    DiscoveryResult,
    Metric,
    Result,
    Service,
    State,
    StringTable,
    render,
)


# =============================================================================
# SECTION PARSING
# =============================================================================

# Section: machine_name -> list of events for that machine
Section = dict[str, list[dict[str, Any]]]


def parse_veeam_rest_malware_events(string_table: StringTable) -> Section | None:
    """Parse JSON list of malware events, grouped by machine."""
    if not string_table:
        return None

    try:
        json_str = "".join(line[0] for line in string_table)
        events = json.loads(json_str)

        if not events:
            return None

        # Group events by machine name
        result: Section = {}
        for event in events:
            machine = event.get("machine", {})
            machine_name = machine.get("name", "Unknown")
            if machine_name not in result:
                result[machine_name] = []
            result[machine_name].append(event)

        return result if result else None
    except (json.JSONDecodeError, IndexError):
        return None


agent_section_veeam_rest_malware_events = AgentSection(
    name="veeam_rest_malware_events",
    parse_function=parse_veeam_rest_malware_events,
)


# =============================================================================
# DISCOVERY
# =============================================================================

def discover_veeam_rest_malware_events(section: Section) -> DiscoveryResult:
    """Discover one service per machine with malware events."""
    for machine_name in section:
        yield Service(item=machine_name)


# =============================================================================
# CHECK FUNCTION
# =============================================================================

# Severity to state mapping
SEVERITY_STATE = {
    "Infected": State.CRIT,
    "Suspicious": State.WARN,
    "Informative": State.OK,
    "Clean": State.OK,
}

# Event type display names
EVENT_TYPE_DISPLAY = {
    "DeletedUsefulFiles": "Deleted useful files",
    "RansomwareNotes": "Ransomware notes",
    "MalwareExtensions": "Malware extensions",
    "YaraRuleMatch": "YARA rule match",
    "AntivirusMatch": "Antivirus match",
    "Unknown": "Unknown",
}

# Source display names
SOURCE_DISPLAY = {
    "Manual": "Manual",
    "InternalVeeamDetector": "Veeam Detector",
    "External": "External",
    "MarkAsCleanEvent": "Marked Clean",
}


def check_veeam_rest_malware_events(
    item: str,
    params: Mapping[str, Any],
    section: Section,
) -> CheckResult:
    """Check malware events for a specific machine."""
    if item not in section:
        yield Result(state=State.OK, summary="No malware events")
        return

    events = section[item]
    if not events:
        yield Result(state=State.OK, summary="No malware events")
        return

    # Count events by state and severity
    total_events = len(events)
    active_events = [e for e in events if e.get("state") != "FalsePositive"]
    false_positives = [e for e in events if e.get("state") == "FalsePositive"]

    # Determine worst severity among active events
    worst_state = State.OK
    worst_severity = "Clean"
    for event in active_events:
        severity = event.get("severity", "Clean")
        event_state = SEVERITY_STATE.get(severity, State.OK)
        if event_state.value > worst_state.value:
            worst_state = event_state
            worst_severity = severity

    # Build summary
    if not active_events:
        summary = f"All {total_events} event(s) confirmed as false positive"
        worst_state = State.OK
    else:
        summary = f"{len(active_events)} active event(s)"
        if worst_severity != "Clean":
            summary += f", worst: {worst_severity}"
        if false_positives:
            summary += f", {len(false_positives)} confirmed clean"

    yield Result(state=worst_state, summary=summary)

    # Metrics
    yield Metric("veeam_rest_malware_events_total", total_events)
    yield Metric("veeam_rest_malware_events_active", len(active_events))
    yield Metric("veeam_rest_malware_events_false_positive", len(false_positives))

    # Details for each active event
    for event in active_events:
        event_type = event.get("type", "Unknown")
        type_display = EVENT_TYPE_DISPLAY.get(event_type, event_type)
        severity = event.get("severity", "Unknown")
        source = event.get("source", "Unknown")
        source_display = SOURCE_DISPLAY.get(source, source)
        details = event.get("details", "")
        detection_time = event.get("detectionTimeUtc", "")

        # Parse detection time for age calculation
        age_str = ""
        if detection_time:
            try:
                dt = datetime.fromisoformat(detection_time.replace("Z", "+00:00"))
                age_seconds = int((datetime.now(timezone.utc) - dt).total_seconds())
                age_str = f", {render.timespan(age_seconds)} ago"
            except (ValueError, TypeError):
                pass

        event_info = f"{type_display} ({severity}) - Source: {source_display}{age_str}"
        if details:
            event_info += f" - {details[:100]}"

        event_state = SEVERITY_STATE.get(severity, State.OK)
        yield Result(state=event_state, notice=event_info)

    # Details for false positives (as notice only)
    for event in false_positives:
        event_type = event.get("type", "Unknown")
        type_display = EVENT_TYPE_DISPLAY.get(event_type, event_type)
        severity = event.get("severity", "Unknown")

        yield Result(
            state=State.OK,
            notice=f"[Confirmed Clean] {type_display} (was: {severity})"
        )


check_plugin_veeam_rest_malware_events = CheckPlugin(
    name="veeam_rest_malware_events",
    service_name="Veeam Malware %s",
    discovery_function=discover_veeam_rest_malware_events,
    check_function=check_veeam_rest_malware_events,
    check_default_parameters={},
    check_ruleset_name="veeam_rest_malware_events",
)
